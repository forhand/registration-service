# Сервис Регистрации

Сервис на Spring Boot для обработки регистрации пользователей с подтверждением по email и телефону.

## Технологии

- Java 17
- Spring Boot 3.5.0
- Spring Security
- Spring Data JPA
- Apache Kafka
- PostgreSQL
- H2 (для тестов)
- Gradle

## Требования

- JDK 17 или выше
- PostgreSQL 12 или выше
- Kafka 

## Сборка проекта

```bash
./gradlew build
```

## Запуск тестов

```bash
./gradlew test
```

### Тестовое окружение

В проекте используется:
- База данных H2 в памяти для тестов
- Встроенный брокер Kafka для интеграционных тестов
- Специальные тестовые конфигурации для Security и Kafka

### Известные проблемы

1. При запуске тестов на Windows могут появляться предупреждения, связанные с удалением временных файлов Kafka:
```
Error deleting Kafka temporary files: FileSystemException: Process cannot access the file because it is being used by another process
```
Это известная проблема очистки Kafka на Windows, которая не влияет на результаты тестов.

2. В случае конфликтов портов со встроенным Kafka, тесты настроены на автоматическое использование случайных доступных портов.

## Локальный запуск

1. Запустите PostgreSQL
2. Запустите Kafka
3. Настройте application.yml под ваши параметры базы данных и Kafka
4. Запустите приложение:
```bash
./gradlew bootRun
```

## API Endpoints

### Регистрация

- `POST /api/v1/registration/email` - Регистрация по email
- `POST /api/v1/registration/phone` - Регистрация по номеру телефона

Пример запроса для регистрации по email:
```json
{
    "email": "user@example.com",
    "password": "password123"
}
```

Пример запроса для регистрации по телефону:
```json
{
    "phone": "+79001234567",
    "password": "password123"
}
```

## Конфигурация

В приложении используются разные профили конфигурации:
- `application.yml` - Основная конфигурация
- `application-test.yml` - Конфигурация для тестов

## Валидация данных

- Email: проверка формата и уникальности
- Телефон: поддержка форматов +7XXXXXXXXXX, 8XXXXXXXXXX, XXXXXXXXXX
- Пароль: минимум 8 символов

## Процесс регистрации

1. **Регистрация по email:**
   - Пользователь отправляет email и пароль
   - Система проверяет уникальность email
   - Отправляется письмо со ссылкой подтверждения
   - После перехода по ссылке аккаунт активируется

2. **Регистрация по телефону:**
   - Пользователь отправляет номер телефона и пароль
   - Система проверяет уникальность номера
   - Отправляется SMS с кодом подтверждения
   - После ввода правильного кода аккаунт активируется

## Рабочий процесс Git

В проекте используется Git Flow:

- `main` - основная ветка, содержит стабильные релизы
- `dev` - ветка разработки, куда попадают все новые функции
- `feature/*` - ветки для разработки новых функций (создаются от `dev`)
- `bugfix/*` - ветки для исправления ошибок (создаются от `dev`)
- `hotfix/*` - ветки для срочных исправлений (создаются от `main`)

### Процесс разработки

1. Создайте ветку от `dev` для новой функции:
```bash
git checkout dev
git pull
git checkout -b feature/my-feature
```

2. Внесите изменения и закоммитьте их:
```bash
git add .
git commit -m "Add my feature"
```

3. Отправьте изменения в репозиторий:
```bash
git push origin feature/my-feature
```

4. Создайте Pull Request в ветку `dev`

### CI/CD

Автоматическая проверка кода запускается:
- При push в ветки `main` и `dev`
- При создании Pull Request в `main` или `dev`
- При ручном запуске через GitHub Actions

Проверки включают:
- Сборку проекта
- Запуск тестов
- Проверку стиля кода (Checkstyle)
- Статический анализ (SpotBugs)
- Анализ покрытия кода тестами (JaCoCo, минимум 80%)
